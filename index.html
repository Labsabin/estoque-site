<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Estoque - Laboratório</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .alert { margin-top: 10px; }
        #login-section { display: block; }
        #main-section { display: none; }
    </style>
</head>
<body>
    <!-- Seção de Login -->
    <div id="login-section" class="container mt-5">
        <h1 class="text-center">Login - Sistema de Gestão de Estoque</h1>
        <div class="card mt-4">
            <div class="card-header">Entrar ou Registrar Conta</div>
            <div class="card-body">
                <form id="form-login">
                    <div class="mb-3">
                        <label>Usuário</label>
                        <input type="text" class="form-control" id="usuario" required>
                    </div>
                    <div class="mb-3">
                        <label>Senha</label>
                        <input type="password" class="form-control" id="senha" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Entrar</button>
                    <button type="button" class="btn btn-secondary" onclick="registrarConta()">Registrar Conta</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Seção Principal (Sistema de Estoque) -->
    <div id="main-section">
        <div class="container mt-5">
            <h1 class="text-center">Sistema de Gestão de Estoque - Laboratório</h1>
            <button class="btn btn-outline-danger mb-3" onclick="logout()">Logout</button>
            
            <!-- Abas -->
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="gestao-tab" data-bs-toggle="tab" data-bs-target="#gestao" type="button" role="tab" aria-controls="gestao" aria-selected="true">Gestão</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button" role="tab" aria-controls="relatorios" aria-selected="false">Relatórios</button>
                </li>
                <li class="nav-item" id="admin-tab-li" role="presentation" style="display: none;">
                    <button class="nav-link" id="admin-tab" data-bs-toggle="tab" data-bs-target="#admin" type="button" role="tab" aria-controls="admin" aria-selected="false">Admin</button>
                </li>
            </ul>
            
            <div class="tab-content" id="myTabContent">
                <!-- Aba Gestão -->
                <div class="tab-pane fade show active" id="gestao" role="tabpanel" aria-labelledby="gestao-tab">
                    <!-- Gestão de Entrada -->
                    <div class="card mt-4">
                        <div class="card-header">Adicionar Material Recebido</div>
                        <div class="card-body">
                            <form id="form-entrada">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>Nome do Material</label>
                                        <input type="text" class="form-control" id="material-entrada" placeholder="Digite o nome" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Quantidade</label>
                                        <input type="number" class="form-control" id="quantidade-entrada" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Fornecedor</label>
                                        <input type="text" class="form-control" id="fornecedor-entrada" placeholder="Digite o fornecedor" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Data Recebimento</label>
                                        <input type="date" class="form-control" id="data-recebimento" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Data Validade</label>
                                        <input type="date" class="form-control" id="data-validade" required>
                                    </div>
                                    <div class="col-md-1">
                                        <label>Min. Estoque</label>
                                        <input type="number" class="form-control" id="min-estoque" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary mt-3">Adicionar</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Distribuição -->
                    <div class="card mt-4">
                        <div class="card-header">Distribuir Material</div>
                        <div class="card-body">
                            <form id="form-distribuicao">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label>Nome do Material</label>
                                        <input type="text" class="form-control" id="material-distribuicao" placeholder="Digite o nome" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Quantidade Retirada</label>
                                        <input type="number" class="form-control" id="quantidade-retirada" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Data Saída</label>
                                        <input type="date" class="form-control" id="data-saida" required>
                                    </div>
                                    <div class="col-md-2">
                                        <label>Para Onde</label>
                                        <input type="text" class="form-control" id="destino" placeholder="Digite o destino" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label>Quem Está Enviando</label>
                                        <input type="text" class="form-control" id="quem-enviando" readonly required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-warning mt-3">Distribuir</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Inventário -->
                    <div class="card mt-4">
                        <div class="card-header">Inventário Atual</div>
                        <div class="card-body">
                            <table class="table table-striped" id="tabela-inventario">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Quantidade</th>
                                        <th>Fornecedor</th>
                                        <th>Data Recebimento</th>
                                        <th>Data Validade</th>
                                        <th>Min. Estoque</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Alertas -->
                    <div class="card mt-4">
                        <div class="card-header">Alertas: Materiais Acabando</div>
                        <div class="card-body" id="alertas"></div>
                    </div>
                </div>
                
                <!-- Aba Relatórios -->
                <div class="tab-pane fade" id="relatorios" role="tabpanel" aria-labelledby="relatorios-tab">
                    <div class="card mt-4">
                        <div class="card-header">Gerar Relatórios em PDF (Tabelas Detalhadas)</div>
                        <div class="card-body">
                            <button class="btn btn-success mb-2" onclick="gerarRelatorioMovimentacao()">Relatório Completo de Movimentações (Entradas e Saídas)</button><br>
                            <button class="btn btn-info mb-2" onclick="gerarRelatorioEstoque()">Relatório do Inventário Atual</button><br>
                            <button class="btn btn-warning mb-2" onclick="gerarRelatorioRecebidosMes()">Relatório de Recebidos no Mês</button><br>
                            <div class="mb-2">
                                <label>Escolher Localidade para Relatório de Retirados:</label>
                                <select class="form-control" id="select-localidade" style="width: 200px; display: inline-block;">
                                    <option value="">Selecione uma localidade</option>
                                </select>
                            </div>
                            <button class="btn btn-danger" onclick="gerarRelatorioRetiradosLocalidade()">Relatório de Retirados por Localidade Selecionada</button>
                        </div>
                    </div>
                </div>
                
                <!-- Aba Admin (Apenas para Master) -->
                <div class="tab-pane fade" id="admin" role="tabpanel" aria-labelledby="admin-tab">
                    <div class="card mt-4">
                        <div class="card-header">Aprovar Contas Pendentes</div>
                        <div class="card-body">
                            <table class="table table-striped" id="tabela-pendentes">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Ação</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dados simulados (localStorage)
        let inventario = JSON.parse(localStorage.getItem('inventario')) || [];
        let movimentacoes = JSON.parse(localStorage.getItem('movimentacoes')) || [];
        let usuariosAprovados = JSON.parse(localStorage.getItem('usuariosAprovados')) || []; // Array de {usuario, senha, master: boolean}
        let usuariosPendentes = JSON.parse(localStorage.getItem('usuariosPendentes')) || []; // Array de {usuario, senha}
        let usuarioLogado = localStorage.getItem('usuarioLogado');

        // Verificar login ao carregar
        window.onload = function() {
            if (usuarioLogado) {
                mostrarSistema();
            } else {
                mostrarLogin();
            }
        };

        // Mostrar login
        function mostrarLogin() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('main-section').style.display = 'none';
        }

        // Mostrar sistema
        function mostrarSistema() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('main-section').style.display = 'block';
            // Preencher "Quem Está Enviando" com usuário logado
            document.getElementById('quem-enviando').value = usuarioLogado;
            // Mostrar aba Admin se for master
            const user = usuariosAprovados.find(u => u.usuario === usuarioLogado);
            if (user && user.master) {
                document.getElementById('admin-tab-li').style.display = 'block';
                carregarPendentes();
            }
            carregarInventario();
        }

        // Registrar conta (pendente)
        function registrarConta() {
            const usuario = document.getElementById('usuario').value.trim();
            const senha = document.getElementById('senha').value.trim();
            if (usuario && senha) {
                if (usuariosAprovados.find(u => u.usuario === usuario) || usuariosPendentes.find(u => u.usuario === usuario)) {
                    alert('Usuário já existe ou está pendente!');
                } else {
                    usuariosPendentes.push({ usuario, senha });
                    localStorage.setItem('usuariosPendentes', JSON.stringify(usuariosPendentes));
                    alert('Conta registrada! Aguarde aprovação do master.');
                }
            } else {
                alert('Preencha usuário e senha.');
            }
        }

        // Formulário de login
        document.getElementById('form-login').addEventListener('submit', function(e) {
            e.preventDefault();
            const usuario = document.getElementById('usuario').value.trim();
            const senha = document.getElementById('senha').value.trim();
            const user = usuariosAprovados.find(u => u.usuario === usuario && u.senha === senha);
            if (user) {
                localStorage.setItem('usuarioLogado', usuario);
                mostrarSistema();
            } else {
                alert('Usuário ou senha incorretos, ou conta não aprovada!');
            }
        });

        // Logout
        function logout() {
            localStorage.removeItem('usuarioLogado');
            mostrarLogin();
        }

        // Carregar pendentes (para master)
        function carregarPendentes() {
            const tbody = document.querySelector('#tabela-pendentes tbody');
            tbody.innerHTML = '';
            usuariosPendentes.forEach((user, index) => {
                tbody.innerHTML += `<tr>
                    <td>${user.usuario}</td>
                    <td><button class="btn btn-success btn-sm" onclick="aprovarConta(${index})">Aprovar</button></td>
                </tr>`;
            });
        }

        // Aprovar conta (master)
        function aprovarConta(index) {
            const user = usuariosPendentes.splice(index, 1)[0];
            usuariosAprovados.push({ usuario: user.usuario, senha: user.senha, master: false });
            localStorage.setItem('usuariosAprovados', JSON.stringify(usuariosAprovados));
            localStorage.setItem('usuariosPendentes', JSON.stringify(usuariosPendentes));
            carregarPendentes();
            alert('Conta aprovada!');
        }

        // Carregar inventário na tabela
        function carregarInventario() {
            const tbody = document.querySelector('#tabela-inventario tbody');
            tbody.innerHTML = '';
            inventario.forEach(item => {
                tbody.innerHTML += `<tr>
                    <td>${item.material}</td>
                    <td>${item.quantidade}</td>
                    <td>${item.fornecedor}</td>
                    <td>${item.dataRecebimento}</td>
                    <td>${item.dataValidade}</td>
                    <td>${item.minEstoque}</td>
                </tr>`;
            });
            carregarAlertas();
            carregarLocalidades();
        }

        // Carregar alertas
        function carregarAlertas() {
            const alertasDiv = document.getElementById('alertas');
            alertasDiv.innerHTML = '';
            inventario.forEach(item => {
                if (item.quantidade <= item.minEstoque) {
                    alertasDiv.innerHTML += `<div class="alert alert-danger">Alerta: ${item.material} está acabando (Quantidade: ${item.quantidade})</div>`;
                }
            });
        }

        // Carregar localidades no select
        function carregarLocalidades() {
            const select = document.getElementById('select-localidade');
            select.innerHTML = '<option value="">Selecione uma localidade</option>';
            const localidades = [...new Set(movimentacoes.filter(mov => mov.tipo === 'Saída').map(mov => mov.destino))];
            localidades.forEach(local => {
                select.innerHTML += `<option value="${local}">${local}</option>`;
            });
        }

        // Formulário de entrada
        document.getElementById('form-entrada').addEventListener('submit', function(e) {
            e.preventDefault();
            const material = document.getElementById('material-entrada').value.trim();
            const quantidade = parseInt(document.getElementById('quantidade-entrada').value);
            const fornecedor = document.getElementById('fornecedor-entrada').value.trim();
            const dataRecebimento = document.getElementById('data-recebimento').value;
            const dataValidade = document.getElementById('data-validade').value;
            const minEstoque = parseInt(document.getElementById('min-estoque').value);

            let item = inventario.find(i => i.material === material);
            if (item) {
                item.quantidade += quantidade;
            } else {
                inventario.push({ material, quantidade, fornecedor, dataRecebimento, dataValidade, minEstoque });
            }
            movimentacoes.push({ tipo: 'Entrada', material, quantidade, data: dataRecebimento, fornecedor });
            salvarDados();
            carregarInventario();
            this.reset();
        });

        // Formulário de distribuição
        document.getElementById('form-distribuicao').addEventListener('submit', function(e) {
            e.preventDefault();
            const material = document.getElementById('material-distribuicao').value.trim();
            const quantidade = parseInt(document.getElementById('quantidade-retirada').value);
            const dataSaida = document.getElementById('data-saida').value;
            const destino = document.getElementById('destino').value.trim();
            const quem = document.getElementById('quem-enviando').value.trim();

            let item = inventario.find(i => i.material === material);
            if (item && item.quantidade >= quantidade) {
                item.quantidade -= quantidade;
                movimentacoes.push({ tipo: 'Saída', material, quantidade, data: dataSaida, destino, quem });
                salvarDados();
                carregarInventario();
                this.reset();
            } else {
                alert('Quantidade insuficiente ou material não encontrado!');
            }
        });

        // Salvar dados
        function salvarDados() {
            localStorage.setItem('inventario', JSON.stringify(inventario));
            localStorage.setItem('movimentacoes', JSON.stringify(movimentacoes));
        }

        // Gerar relatório
